echo "ğŸ” Running pre-commit checks..."

# Function to check if we're in a git repository
check_git_repo() {
  if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "âŒ Not in a git repository"
    exit 1
  fi
}

# Function to run checks in a directory if it exists
run_checks_in_dir() {
  local dir=$1
  local name=$2
  
  if [ -d "$dir" ]; then
    echo "ğŸ“ Running $name checks..."
    cd "$dir"
    
    # Check if package.json exists
    if [ -f "package.json" ]; then
      echo "  ğŸ§¹ Linting..."
      if npm run lint; then
        echo "  âœ… Linting passed"
      else
        echo "  âŒ Linting failed"
        exit 1
      fi
      
      echo "  ğŸ”§ Type checking..."
      if npm run build; then
        echo "  âœ… Type checking passed"
      else
        echo "  âŒ Type checking failed"
        exit 1
      fi
      
      echo "  ğŸ§ª Running tests..."
      # Use test:ci if available, otherwise fall back to regular test
      if npm run test:ci 2>/dev/null || npm test -- --passWithNoTests --silent; then
        echo "  âœ… Tests passed"
      else
        echo "  âŒ Tests failed"
        exit 1
      fi
    else
      echo "  âš ï¸  No package.json found, skipping $name checks"
    fi
    
    cd ..
  else
    echo "  âš ï¸  $dir directory not found, skipping $name checks"
  fi
}

# Main execution
check_git_repo

# Run backend checks
run_checks_in_dir "backend" "Backend"

# Run frontend checks
run_checks_in_dir "frontend" "Frontend"

echo "ğŸ‰ All pre-commit checks passed!"